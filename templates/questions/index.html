<!doctype html>
<html lang="en">
<head>
{% include 'questions/header.html' %}    
    <script>
        window.table;
        $(document).ready( function () {          
            const refreshMark = ()=>{
                let fullMark = $('#fullMark').val();
                let minimumSimilarity = $('#minimumSimilarity').val();
                let granularity = $('#granularity').val();
                $('.mark')
                    .attr("max",$('#fullMark').val())
                    .attr("step",$('#granularity').val())
                .each(function( element ) {                    
                    let overridedMark = $("#" + element.id + "-locked").html();
                    
                    if(overridedMark){
                        console.log("overridedMark:"+overridedMark);
                        return;
                    }
                    let similarity = $(this).data("similarity");                 
                    if(similarity >= minimumSimilarity) $(this).val(fullMark);
                    else{
                        let mark = fullMark * similarity;
                        mark = Math.floor(mark / granularity) * granularity;
                        $(this).val(mark);
                    }
                });
                saveMark();
            };
            
            window.table = $('#marksheet').DataTable({
                order: [[ 3, "desc" ]],
                paging: false,
                autoWidth: true,
                columnDefs: [
                    { width: '50%', targets: 1 },
                    { visible: false, targets: 1 },  // Hide Image column by default
                    { 
                        targets: 3,
                        render: function(data, type, row) {
                            if(type === 'sort' || type === 'filter') {
                                return $('input', $('<div>').html(data)).val();
                            }
                            return data;
                        }
                    }
                ],
            } );
            
            // Hide imageControls by default since Image column is hidden
            $('#imageControls').css('display', 'none');
            
            // Function to get column visibility from cookies
            function getColumnVisibility(columnName) {
                const name = `col-${columnName}=`;
                const decodedCookie = decodeURIComponent(document.cookie);
                const ca = decodedCookie.split(';');
                for(let i = 0; i < ca.length; i++) {
                    let c = ca[i].trim();
                    if (c.indexOf(name) == 0) {
                        return c.substring(name.length, c.length) === 'true';
                    }
                }
                return null;
            }
            
            // Apply saved column visibility from cookies
            $('a.toggle-vis, button.toggle-vis').each(function() {
                let columnName = $(this).text().toLowerCase();
                let savedVisibility = getColumnVisibility(columnName);
                
                if (savedVisibility !== null) {
                    let colNum = $(this).attr('data-column');
                    let column = window.table.column(colNum);
                    column.visible(savedVisibility);
                    
                    // Update imageControls visibility for Image column
                    if (columnName === 'image') {
                        if (savedVisibility) {
                            $('#imageControls').css('display', 'contents');
                        } else {
                            $('#imageControls').css('display', 'none');
                        }
                    }
                }
            });
            
            // Initialize toggle button styles
            $('a.toggle-vis, button.toggle-vis').each(function() {
                let colNum = $(this).attr('data-column');
                let column = window.table.column(colNum);
                let isVisible = column.visible();
                if (isVisible) {
                    $(this).css({'background-color': '#4CAF50', 'color': 'white', 'border-color': '#45a049'});
                } else {
                    $(this).css({'background-color': '#f5f5f5', 'color': '#999', 'border-color': '#ccc'});
                }
            });
            
            $('#minimumSimilarity').on('change',function(e){
                $('#currentSimilarity').html(e.target.value);
                refreshMark();
            });
            
            $('#granularity').on('change',function(e){
                $('#currentGranularity').html(e.target.value);
                refreshMark();
            });
            
            $('#fullMark').on('change',function(e){
                refreshMark();
            });
            
            $('#overridedStandardAnswer').on('change',function(e){
                let newValue = e.target.value;
                let standardAnswer = $('#overridedStandardAnswer').data('standardAnswer'); 
                if(newValue!==standardAnswer)
                    $('#regenerate').prop('checked', true);                
            });
        });
    </script>
</head>
<body>
	<header>
        <div style="margin-bottom: 10px;">
            <a href="../../index.html">Back to the question list</a>
        </div>
        <h1>Scoring forms for {{studentsScriptFileName}} - {{question}}</h1>
        <p>Marking Scheme: {{standardAnswer|markdown|safe if standardAnswer is not none}}</p>       
	</header>
	<section> 
        <div id="dialog" title="Large Image">
            <img id="largeImage" src="" style="vertical-align: top; padding: 0px 10px 10px 2px; width: 100%; height: 100%" />
        </div>

        <div style="margin-bottom: 15px;">
            <!-- Control Form - First Row -->
            <form id="controlForm" action="" method="get" style="display: flex; gap: 8px 12px; font-size: 14px; align-items: center; flex-wrap: wrap; margin-bottom: 8px;">
                <div style="display: flex; align-items: center; gap: 5px; white-space: nowrap;">
                    <label for="fullMark" style="font-size: 14px; min-width: 60px;">Full mark:</label>
                    <input type="number" id="fullMark" name="fullMark" min="1" max="100" value="{{standardMark}}" style="width: 50px; font-size: 14px;">
                </div>
                <div style="display: flex; align-items: center; gap: 5px; white-space: nowrap;">
                    <label for="minimumSimilarity" style="font-size: 14px; min-width: 60px;">Similarity:</label>
                    <input type="range" id="minimumSimilarity" name="minimumSimilarity" min="0.1" max="1" value="0.8" step="0.01" style="width: 80px;" />
                    <span id="currentSimilarity" style="width: 25px; font-size: 13px;">0.8</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px; white-space: nowrap;">
                    <label for="granularity" style="font-size: 14px; min-width: 60px;">Granularity:</label>
                    <input type="range" id="granularity" name="granularity" min="0" max="1" value="1" step="0.25" style="width: 80px;" />  
                    <span id="currentGranularity" style="width: 25px; font-size: 13px;">1</span>
                </div>
                <div id="imageControls" style="display: contents;">
                    <div style="display: flex; align-items: center; gap: 5px; white-space: nowrap;">
                        <label for="zoom" style="font-size: 14px;">Zoom:</label>
                        <input type="range" id="zoom" name="zoom" min="0.1" max="2" value="1" step="0.1" style="width: 80px;" />  
                        <span id="currentZoom" style="width: 25px; font-size: 13px;">1</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px; white-space: nowrap;">
                        <label for="top" style="font-size: 14px;">Top:</label>
                        <input type="number" id="top" name="top" min="0" step="10" class="changeBoundBox" value="{{estimatedBoundingBox["top"]}}" style="width: 60px; font-size: 14px;" />
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px; white-space: nowrap;">
                        <label for="left" style="font-size: 14px;">Left:</label>
                        <input type="number" id="left" name="left" min="0" step="10" class="changeBoundBox" value="{{estimatedBoundingBox["left"]}}" style="width: 60px; font-size: 14px;" />
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px; white-space: nowrap;">
                        <label for="height" style="font-size: 14px;">Height:</label>
                        <input type="number" id="height" name="height" min="0" step="10" class="changeBoundBox" value="{{estimatedBoundingBox["height"]}}" style="width: 60px; font-size: 14px;" />
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px; white-space: nowrap;">
                        <label for="width" style="font-size: 14px;">Width:</label>
                        <input type="number" id="width" name="width" min="0" step="10" class="changeBoundBox" value="{{estimatedBoundingBox["width"]}}" style="width: 60px; font-size: 14px;" />
                    </div>
                </div>
            </form>
            
            <!-- Toggle Buttons - Second Row -->
            <div style="display: flex; gap: 3px; align-items: center;">
                <span style="font-weight: bold; font-size: 11px; white-space: nowrap;">Show/Hide:</span>
                <button type="button" class="toggle-vis" data-column="1" style="padding: 2px 5px; border: 1px solid #ccc; background: white; border-radius: 4px; cursor: pointer; font-size: 11px; white-space: nowrap;">Image</button>
                <button type="button" class="toggle-vis" data-column="2" style="padding: 2px 5px; border: 1px solid #ccc; background: white; border-radius: 4px; cursor: pointer; font-size: 11px; white-space: nowrap;">Answer</button>
                <button type="button" class="toggle-vis" data-column="3" style="padding: 2px 5px; border: 1px solid #ccc; background: white; border-radius: 4px; cursor: pointer; font-size: 11px; white-space: nowrap;">Mark</button>
                <button type="button" class="toggle-vis" data-column="4" style="padding: 2px 5px; border: 1px solid #ccc; background: white; border-radius: 4px; cursor: pointer; font-size: 11px; white-space: nowrap;">Similarity</button>
                <button type="button" class="toggle-vis" data-column="5" style="padding: 2px 5px; border: 1px solid #ccc; background: white; border-radius: 4px; cursor: pointer; font-size: 11px; white-space: nowrap;">Reasoning</button>
            </div>
        </div>
        <div>
            <p>If your type in the mark, it will be locked. To unlock, click on the mark below the mark input.</p>
        </div>
        <div style="margin: 20px 0; padding: 10px; background-color: #f5f5f5; border-radius: 5px;">
            {% if prev_question %}
                <a href="../{{prev_question}}/index.html">← Previous: {{prev_question}}</a>
            {% else %}
                <span style="color: #999;">← Previous</span>
            {% endif %}
            <span style="margin: 0 10px;">|</span>
            {% if next_question %}
                <a href="../{{next_question}}/index.html">Next: {{next_question}} →</a>
            {% else %}
                <span style="color: #999;">Next →</span>
            {% endif %}
        </div>
        <form id="markForm" action="" method="get" class="form">
            <table id="marksheet" class="display" style="width:100%">
                <thead>
                  <tr>
                    <th>Row</th>
                    <th>Image</th>
                    <th>Answer</th>
                    <th>Mark</th>                      
                    <th>Similarity</th>
                    <th>Reasoning</th>                  
                  </tr>
                </thead>
                <tbody>
{% for index, row in dataTable.iterrows() -%}
                  <tr>
                    <td>{{row["RowNumber"]}}</td>          
                    <td> 
                        <div id="crop-{{row["page"]}}-container" >
                            <img src="../../{{row["Image"]}}" 
                                 id="crop-{{row["page"]}}" 
                                 class="answerImage crop-{{row["page"]}}"
                                 alt="{{row["Answer"]}}" 
                                 data-left="{{row["left"]}}"
                                 data-top="{{row["top"]}}"
                                 data-width="{{row["width"]}}"
                                 data-height="{{row["height"]}}"
                            />
                        </div>   
                    </td>
                    <td>{{row["Answer"]}}</td>  
                    <td>
                        <input type="number" id="mark-{{row["page"]}}" min="0" value="{{row["Mark"]}}" max="1" step="1" 
                               class="mark" 
                               data-similarity="{{[row["Similarity"],0]|max}}"                              
                               required /> 
                        <span id="mark-{{row["page"]}}-locked" class="lock"></span>
                    </td>
                    <td>{{'%0.2f'| format([row["Similarity"],0]|max|float)}}</td>
                    <td>{{row.get("Reasoning", "N/A")}}
                        {% if row.get("ModeratorFlag") == True %}<br/>
                            <strong>Moderator Note:{{row.get("ModeratorNote", "N/A")}}</strong>
                            <strong> Change from {{row.get("MarkRaw", "N/A")}} to  {{row.get("Mark", "N/A")}}</strong>
                        {% endif %}
                    </td>                    
                  </tr>      
{% endfor %} 
                </tbody>
            </table>
        </form>
        <div style="margin: 20px 0; padding: 10px; background-color: #f5f5f5; border-radius: 5px;">
            <a href="../../index.html">Back to the question list</a>
            <span style="margin: 0 20px;">|</span>
            {% if prev_question %}
                <a href="../{{prev_question}}/index.html">← Previous: {{prev_question}}</a>
            {% else %}
                <span style="color: #999;">← Previous</span>
            {% endif %}
            <span style="margin: 0 10px;">|</span>
            {% if next_question %}
                <a href="../{{next_question}}/index.html">Next: {{next_question}} →</a>
            {% else %}
                <span style="color: #999;">Next →</span>
            {% endif %}
        </div>
	</section>
	<footer>
		<p>Created by Higher Diploma in Cloud and Data Centre Administration Developement Team. </p>
	</footer>
</body>
</html>